# 31 October 2019
# WD: /home/jkimball/haasx092/main_GBS
# This is the SNP calling step for ~ half of the main_GBS population (JohnsonDora removed as well has roughly half of the samples to reduce final size of the files and make analysis easier/faster for the ASA poster)

module load samtools
module load bcftools
module load htslib
module load parallel

bams="191031_sorted_bams_slim.txt"
prefix="191031_samtools"
parallel_samtools_processes=15
ref="/home/jkimball/mshao/genome_seq/zizania_palustris_13Nov2018_okGsv.fasta"

mkdir -p $prefix
cut -f 1 ${ref}.fai \
 | parallel --will-cite -I'{}' -j $parallel_samtools_processes \
  \(samtools mpileup -q 40 -gDVu \
  -b $bams \
  -r '{}' \
  -f ${ref} \
  \| bcftools call -mv \
  \| bgzip -c \
  \> $prefix/${prefix}_'{}'.vcf.gz \) \
  2\> $prefix/${prefix}_'{}'.err